---
title: "US Research University Prediction Model"
author: "Philip Gabriel Andrada"
date: "October 28, 2016"
output: pdf_document
---

#Preparation

```{r}
#loading necessary libraries
library(rpart)
library(randomForest)
library(caret)
library(bigglm)
library(Boruta)
library(speedglm)
library(ggplot2)
library(e1071)
library(ROCR)

#Reading Data Files
usuniv2012 <- read.csv("C:\\Users\\pandrada\\Desktop\\Capstone\\MERGED2012_13_PP.csv")
usuniv2013 <- read.csv("C:\\Users\\pandrada\\Desktop\\Capstone\\MERGED2013_14_PP.csv")
usuniv2014 <- read.csv("C:\\Users\\pandrada\\Desktop\\Capstone\\MERGED2014_15_PP.csv")

#Binding All Data Files into One Data Frame
usuniv <- rbind(usuniv2012,usuniv2013,usuniv2014)

#Since there are some incomplete Carnegie Classifications, we use usuniv2014 as basis for the classification for the rest
usuniv$CCBASIC2 <- usuniv2014$CCBASIC[match(usuniv$OPEID6,usuniv2014$OPEID6)]

#added the ACCEPTED column for those that are research universities (CCBASIC2 is equal to 15 or 16), as our focus will be on these
usuniv$ACCEPTED <- ifelse(usuniv$CCBASIC2 %in% c(15,16), 1, 0)

#We will create another data frame for the research universities only
usresearchuniv <- usuniv[usuniv$CCBASIC2 %in% c(15,16),]

#Create a vector with the columns that is needed from the study
# 19 - institution region (1-New England, 2-Mid East, 3-Great Lakes, 4-Plains, 5-Southeast, 6-Southwest, 7-Rocky Mountains, 8-Far West, 9-Outlying Areas)
# 37-38 - admission rate
# 39-61 - SAT and ACT Scores
# 62-99 - percentage of degrees awarded for each field of study
# 293-299 - total share of enrollment for different ethnicities
# 300 - total share of enrollment that are non-resident aliens (i.e. international students)
# 301 - total share of enrollment that have unknown race
# 314 - share of undergraduate, degree-/certificate-seeking students who are part-time
# 377 - average cost of attendance in an academic year institution
# 379 - in-state tuition and fees
# 380 - out-of-state tuition and fees
# 387 - completion rate of first-time, full-time students at four-year institutions with 150% of expected time to completion)
# 397-403 - completion rate for first-time, full-time students for different ethnicities
# 404 - completion rate for first-time, full-time students for non-resident aliens
# 405 - completion rate for first-time, full-time students that have unknown race
# 429 - retention rate for first-time, full time studnets at four-year institutions
# 438 - percent of all federal undergraduate students receiving a federal student loan
# 1412 - percentage of first-generation students
# 1740-1741 - total share of enrollment per gender
# 1745 - acceptance flag
col_select <- c(19,37:99,293:301,314,377,379:380,387,397:405,429,438,1412,1740:1741, 1745)

# Create a new data frame with the columns that will be filtered out
usunivfilter <- usuniv[,col_select]

# Change the factor columns to numeric for faster processing
usunivfilter$C150_4 <- as.numeric(as.character(usunivfilter$C150_4))
usunivfilter$ADM_RATE_ALL <- as.numeric(as.character(usunivfilter$ADM_RATE_ALL))
usunivfilter$SAT_AVG_ALL <- as.numeric(as.character(usunivfilter$SAT_AVG_ALL))
usunivfilter$UGDS_ASIAN <- as.numeric(as.character(usunivfilter$UGDS_ASIAN))
usunivfilter$UGDS_WHITE <- as.numeric(as.character(usunivfilter$UGDS_WHITE))
usunivfilter$UGDS_BLACK <- as.numeric(as.character(usunivfilter$UGDS_BLACK))
usunivfilter$UGDS_MEN <- as.numeric(as.character(usunivfilter$UGDS_MEN))
usunivfilter$UGDS_WOMEN <- as.numeric(as.character(usunivfilter$UGDS_WOMEN))
usunivfilter$COSTT4_A <- as.numeric(as.character(usunivfilter$COSTT4_A))
usunivfilter$PCIP11 <- as.numeric(as.character(usunivfilter$PCIP11))
usunivfilter$PCTFLOAN <- as.numeric(as.character(usunivfilter$PCTFLOAN))
usunivfilter$PPTUG_EF <- as.numeric(as.character(usunivfilter$PPTUG_EF))
usunivfilter$RET_FT4 <- as.numeric(as.character(usunivfilter$RET_FT4))
usunivfilter$PAR_ED_PCT_1STGEN <- as.numeric(as.character(usunivfilter$PAR_ED_PCT_1STGEN))

# Clean the results to have all complete 
usunivfilter <- usunivfilter[!is.na(usunivfilter$C150_4),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$ADM_RATE_ALL),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$SAT_AVG_ALL),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$UGDS_ASIAN),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$UGDS_WHITE),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$UGDS_BLACK),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$UGDS_WOMEN),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$UGDS_MEN),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$COSTT4_A),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$PCIP11),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$PCTFLOAN),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$PPTUG_EF),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$RET_FT4),]
usunivfilter <- usunivfilter[!is.na(usunivfilter$PAR_ED_PCT_1STGEN),]

```

#U.S. Research University Acceptance Model
```{r}
# create a training and test model using a 75%/25% from the data set 
rm_train <- sample(nrow(usunivfilter), floor(nrow(usunivfilter)*0.75))
univ_train <- usunivfilter[rm_train_cleansed,]
univ_test <- usunivfilter[-rm_train_cleansed,]

# create a formula for the US research university acceptance model
# test_formulagen <- formula(ACCEPTED ~ REGION + ADM_RATE_ALL + SAT_AVG_ALL + PCIP11 + PCIP12 + PCIP14 + PCIP15 + PCIP26 + PCIP27 + PCIP40 + PCIP41 + UGDS_ASIAN + UGDS_AIAN + UGDS_NHPI + UGDS_2MOR + UGDS_NRA + UGDS_UNKN + COSTT4_A + PCTFLOAN +  UGDS_WOMEN)

# Create a formula to check to predict a female Asian student could be accepted in a US research university for

test_formula_asian_CS <- formula(ACCEPTED ~ REGION + ADM_RATE_ALL + SAT_AVG_ALL + PCIP11 + UGDS_ASIAN + COSTT4_A + PCTFLOAN +  UGDS_WOMEN)


model_glm <- glm(test_formula_asian_CS, data=utrain,family=binomial())

test$scores <- predict(model_glm, type="response", newdata = utest)
pred <- prediction(utest$scores, utest$ACCEPTED)
c <- confusionMatrix(as.integer(utest$scores > 0.5), utest$ACCEPTED)
c$table
perf <- performance(pred,"tpr","fpr")
plot(perf,lty=1)

#other formulas to consider
test_formula_asian_CS_noadm <- formula(ACCEPTED ~ REGION + SAT_AVG_ALL + PCIP11 + UGDS_ASIAN + COSTT4_A + PCTFLOAN +  UGDS_WOMEN)

test_formula2 <- formula(ACCEPTED ~ PCIP01 + PCIP03 + PCIP04 + PCIP05 + PCIP09 + PCIP10 + PCIP11 + PCIP12 + PCIP13 + PCIP14 + PCIP15 + PCIP16 + PCIP19 + PCIP22 + PCIP23 + PCIP24 + PCIP25 + PCIP26 + PCIP27 + PCIP29 + PCIP30 + PCIP31 + PCIP38 + PCIP39 + PCIP40 + PCIP41 + PCIP42 + PCIP43 + PCIP44 + PCIP45 + PCIP46 + PCIP47 + PCIP48 + PCIP49 + PCIP50 + PCIP51 + PCIP52 + PCIP54)

test_formula3 <- formula(ACCEPTED ~ UGDS_WHITE + UGDS_BLACK + UGDS_HISP + UGDS_ASIAN + UGDS_AIAN + UGDS_NHPI + UGDS_2MOR + UGDS_NRA + UGDS_UNKN)

formula_comp_asian2 <- formula(C150_4 ~ ADM_RATE_ALL + SAT_AVG_ALL + UGDS_ASIAN + PPTUG_EF + RET_FT4 + PAR_ED_PCT_1STGEN + UGDS_MEN )

# add formula for random forest, svr and other methods of prediction

```

# US Research University Completion Rate Prediction Model

```{r}

```